{"tags":[{"name":"AC自动机","permalink":"http://lzy-foenix.github.io/tags/AC自动机/","url":"\\async\\tags\\AC自动机.json","count":2}],"categories":[{"name":"字符串","permalink":"http://lzy-foenix.github.io/categories/字符串/","url":"\\async\\categories\\字符串.json","count":2}],"url":"\\async\\posts\\2015\\03\\29\\AC自动机.json","date":1427627221000,"path":{"year":2015,"month":3,"day":29,"name":"AC自动机"},"title":"AC自动机","permalink":"http://lzy-foenix.github.io/2015/03/29/AC自动机/","content":"<hr>\n<a id=\"more\"></a>\n<p>转载：<a href=\"http://blog.csdn.net/niushuai666/article/details/7002823\" target=\"_blank\" rel=\"external\">飘过的小牛</a>和<a href=\"http://55242.cf/2015/03/13/AC%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%B0%8F%E7%BB%93/#more\" target=\"_blank\" rel=\"external\">hzoi_jsx</a></p>\n<h3 id=\"简介：\"><a href=\"#简介：\" class=\"headerlink\" title=\"简介：\"></a>简介：</h3><blockquote>\n<p>AC自动机(不是顾名思义，不能自动AC…)。该算法在1975年产生于贝尔实验室，是著名的多模匹配算法之一。一个常见的例子就是给出n个单词，再给出一段包含m个字符的文章，让你找出有多少个单词在文章里出现过。要搞懂AC自动机，先得有字典树Trie和KMP模式匹配算法的基础知识。KMP算法是单模式串的字符匹配算法，AC自动机是多模式串的字符匹配算法。</p>\n<h3 id=\"构建：\"><a href=\"#构建：\" class=\"headerlink\" title=\"构建：\"></a>构建：</h3><p>1.构造一棵Trie，作为AC自动机的搜索数据结构<br>构造fail指针，<strong>使当前字符失配时跳转到具有最长公共前后缀的字符继续匹配</strong>。如同 KMP算法一样， 2.AC自动机在匹配时如果当前字符匹配失败，那么利用fail指针进行跳转。由此可知如果跳转，跳转后的串的前缀，必为跳转前的模式串的后缀并且跳转的新位置的深度（匹配字符个数）一定小于跳之前的节点。所以我们可以利用bfs在 Trie上面进行 fail指针的求解。<br>3.扫描主串进行匹配。</p>\n</blockquote>\n<h3 id=\"详解：\"><a href=\"#详解：\" class=\"headerlink\" title=\"详解：\"></a>详解：</h3><h4 id=\"一-Trie\"><a href=\"#一-Trie\" class=\"headerlink\" title=\"一.Trie\"></a>一.Trie</h4><p>首先我们需要建立一棵Trie。但是这棵Trie不是普通的Trie，而是带有一些特殊的性质。<br>首先会有3个重要的指针，分别为p, p-&gt;fail, temp。<br>1.指针p，指向当前匹配的字符。若p指向root，表示当前匹配的字符序列为空。（root是Trie入口，没有实际含义）。<br>2.指针p-&gt;fail，p的失败指针，指向与字符p相同的结点，若没有，则指向root。<br>3.指针temp，测试指针（自己命名的，容易理解！~），在建立fail指针时有寻找与p字符匹配的结点的作用，在扫描时作用最大，也最不好理解。<br>对于Trie树中的一个节点，对应一个序列s[1…m]。此时，p指向字符s[m]。若在下一个字符处失配，即p-&gt;next[s[m+1]] == NULL，则由失配指针跳到另一个节点(p-&gt;fail)处，该节点对应的序列为s[i…m]。若继续失配，则序列依次跳转直到序列为空或出现匹配。在此过程中，p的值一直在变化，但是p对应节点的字符没有发生变化。在此过程中，我们观察可知，最终求得得序列s则为最长公共后缀。另外，由于这个序列是从root开始到某一节点，则说明这个序列有可能是某些序列的前缀。<br>再次讨论p指针转移的意义。如果p指针在某一字符s[m+1]处失配(即p-&gt;next[s[m+1]] == NULL)，则说明没有单词s[1…m+1]存在。此时，如果p的失配指针指向root，则说明当前序列的任意后缀不会是某个单词的前缀。如果p的失配指针不指向root，则说明序列s[i…m]是某一单词的前缀，于是跳转到p的失配指针，以s[i…m]为前缀继续匹配s[m+1]。<br>对于已经得到的序列s[1…m]，由于s[i…m]可能是某单词的后缀，s[1…j]可能是某单词的前缀，所以s[1…m]中可能会出现单词。此时，p指向已匹配的字符，不能动。于是，令temp = p，然后依次测试s[1…m], s[i…m]是否是单词。<br>构造的Trie为：<img src=\"http://images.cppblog.com/cppblog_com/mythit/ac1.jpg\" alt=\"\"></p>\n<h4 id=\"二、构造失败指针\"><a href=\"#二、构造失败指针\" class=\"headerlink\" title=\"二、构造失败指针\"></a>二、构造失败指针</h4><p>用BFS来构造失败指针，与KMP算法相似的思想。<br>首先，root入队，第1次循环时处理与root相连的字符，也就是各个单词的第一个字符h和s，因为第一个字符不匹配需要重新匹配，所以第一个字符都指向root（root是Trie入口，没有实际含义）失败指针的指向对应下图中的(1)，(2)两条虚线；第2次进入循环后，从队列中先弹出h，接下来p指向h节点的fail指针指向的节点，也就是root；p=p-&gt;fail也就是p=NULL说明匹配序列为空，则把节点e的fail指针指向root表示没有匹配序列，对应图-2中的(3)，然后节点e进入队列；第3次循环时，弹出的第一个节点a的操作与上一步操作的节点e相同，把a的fail指针指向root，对应图-2中的(4)，并入队；第4次进入循环时，弹出节点h(图中左边那个)，这时操作略有不同。由于p-&gt;next[i]!=NULL(root有h这个儿子节点，图中右边那个)，这样便把左边那个h节点的失败指针指向右边那个root的儿子节点h，对应图-2中的(5)，然后h入队。以此类推：在循环结束后，所有的失败指针就是图-2中的这种形式。<img src=\"http://images.cppblog.com/cppblog_com/mythit/ac2.JPG\" alt=\"\"></p>\n<h4 id=\"三、扫描\"><a href=\"#三、扫描\" class=\"headerlink\" title=\"三、扫描\"></a>三、扫描</h4><p>构造好Trie和失败指针后，我们就可以对主串进行扫描了。这个过程和KMP算法很类似，但是也有一定的区别，主要是因为AC自动机处理的是多串模式，需要防止遗漏某个单词，所以引入temp指针。<br>匹配过程分两种情况：(1)当前字符匹配，表示从当前节点沿着树边有一条路径可以到达目标字符，此时只需沿该路径走向下一个节点继续匹配即可，目标字符串指针移向下个字符继续匹配；(2)当前字符不匹配，则去当前节点失败指针所指向的字符继续匹配，匹配过程随着指针指向root结束。重复这2个过程中的任意一个，直到模式串走到结尾为止。<br> 对照上图，看一下模式匹配这个详细的流程，其中模式串为yasherhs。对于i=0,1。Trie中没有对应的路径，故不做任何操作；i=2,3,4时，指针p走到左下节点e。因为节点e的count信息为1，所以cnt+1，并且讲节点e的count值设置为-1，表示改单词已经出现过了，防止重复计数，最后temp指向e节点的失败指针所指向的节点继续查找，以此类推，最后temp指向root，退出while循环，这个过程中count增加了2。表示找到了2个单词she和he。当i=5时，程序进入第5行，p指向其失败指针的节点，也就是右边那个e节点，随后在第6行指向r节点，r节点的count值为1，从而count+1，循环直到temp指向root为止。最后i=6,7时，找不到任何匹配，匹配过程结束。</p>\n<h3 id=\"模板：\"><a href=\"#模板：\" class=\"headerlink\" title=\"模板：\"></a>模板：</h3><p><a href=\"http://acm.hdu.edu.cn/showproblem.php?pid=2222\" target=\"_blank\" rel=\"external\">可戳：HDU2222</a><br><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;cstdio&gt;</span></span></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;queue&gt;</span></span></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;cstring&gt;</span></span></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;algorithm&gt;</span></span></div><div class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> <span class=\"built_in\">std</span>;</div><div class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> LL;</div><div class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> T&gt;<span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"keyword\">void</span> <span class=\"title\">Read</span><span class=\"params\">(T&amp; x)</span></span>&#123;</div><div class=\"line\">\tx=<span class=\"number\">0</span>; <span class=\"keyword\">bool</span> flag=<span class=\"number\">0</span>; <span class=\"keyword\">char</span> ch=getchar();</div><div class=\"line\">\t<span class=\"keyword\">while</span>(ch&gt; <span class=\"string\">'9'</span> || ch&lt; <span class=\"string\">'0'</span>)&#123; <span class=\"keyword\">if</span>(ch==<span class=\"string\">'-'</span>)&#123; flag=<span class=\"number\">1</span>; ch=getchar(); <span class=\"keyword\">break</span>; &#125; ch=getchar();&#125;</div><div class=\"line\">\t<span class=\"keyword\">while</span>(ch&gt;=<span class=\"string\">'0'</span> &amp;&amp; ch&lt;=<span class=\"string\">'9'</span>)&#123; x=x*<span class=\"number\">10</span>+ch<span class=\"number\">-48</span>; ch=getchar(); &#125;</div><div class=\"line\">\t<span class=\"keyword\">if</span>(flag) x=-x;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">const</span> <span class=\"keyword\">int</span> MAXN = <span class=\"number\">500010</span>;</div><div class=\"line\"><span class=\"keyword\">struct</span> TRIE &#123;</div><div class=\"line\">\t<span class=\"keyword\">int</span> next[MAXN][<span class=\"number\">26</span>],fail[MAXN],end[MAXN];</div><div class=\"line\">\t<span class=\"keyword\">int</span> L , root;</div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">newnode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt; <span class=\"number\">26</span>;++i) next[L][i] = <span class=\"number\">-1</span>;</div><div class=\"line\">\t\tend[L++] = <span class=\"number\">0</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> L<span class=\"number\">-1</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123; L = <span class=\"number\">0</span>; root = newnode(); &#125;</div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">insert</span><span class=\"params\">(<span class=\"keyword\">char</span> *buf)</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">int</span> len = <span class=\"built_in\">strlen</span>(buf) , now = root;</div><div class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt; len;++i) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span>(next[now][buf[i]-<span class=\"string\">'a'</span>] == <span class=\"number\">-1</span>)</div><div class=\"line\">\t\t\t\tnext[now][buf[i]-<span class=\"string\">'a'</span>] = newnode();</div><div class=\"line\">\t\t\tnow = next[now][buf[i]-<span class=\"string\">'a'</span>];</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tend[now]++;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">build</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"built_in\">queue</span>&lt;<span class=\"keyword\">int</span>&gt;Q;</div><div class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt; <span class=\"number\">26</span>;++i) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span>(next[root][i] == <span class=\"number\">-1</span>) next[root][i] = root;</div><div class=\"line\">\t\t\t<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t\t\tfail[next[root][i]] = root;</div><div class=\"line\">\t\t\t\tQ.push(next[root][i]);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">while</span>(!Q.empty()) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">int</span> now = Q.front(); Q.pop();</div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt; <span class=\"number\">26</span>;++i) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">if</span>(next[now][i] == <span class=\"number\">-1</span>) next[now][i] = next[fail[now]][i];</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t\t\t\tfail[next[now][i]] = next[fail[now]][i];</div><div class=\"line\">\t\t\t\t\tQ.push(next[now][i]);</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">query</span><span class=\"params\">(<span class=\"keyword\">char</span> *buf)</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">int</span> len = <span class=\"built_in\">strlen</span>(buf),now = root,res = <span class=\"number\">0</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt; len;++i) &#123;</div><div class=\"line\">\t\t\tnow = next[now][buf[i]-<span class=\"string\">'a'</span>];</div><div class=\"line\">\t\t\t<span class=\"keyword\">int</span> temp = now;</div><div class=\"line\">\t\t\t<span class=\"keyword\">while</span>(temp != root)&#123;</div><div class=\"line\">\t\t\t\tres += end[temp];</div><div class=\"line\">\t\t\t\tend[temp] = <span class=\"number\">0</span>;</div><div class=\"line\">\t\t\t\ttemp = fail[temp];</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> res;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;AC;</div><div class=\"line\"><span class=\"keyword\">char</span> buf[<span class=\"number\">1000010</span>];</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">int</span> T,n;</div><div class=\"line\">\tRead(T);</div><div class=\"line\">\t<span class=\"keyword\">while</span>(T--)&#123;</div><div class=\"line\">\t\tRead(n);</div><div class=\"line\">\t\tAC.init();</div><div class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt; n;++i)&#123;</div><div class=\"line\">\t\t\t<span class=\"built_in\">scanf</span>(<span class=\"string\">\"%s\"</span>,buf);</div><div class=\"line\">\t\t\tAC.insert(buf);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tAC.build();</div><div class=\"line\">\t\t<span class=\"built_in\">scanf</span>(<span class=\"string\">\"%s\"</span>,buf);</div><div class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"%d\\n\"</span>,AC.query(buf));</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n"}